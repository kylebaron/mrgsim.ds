# mrgsim.ds

`mrgsim.ds` provides an [Apache
Arrow](https://arrow.apache.org/docs/r/)-backed simulation output object
for [mrgsolve](https://mrgsolve.org), greatly reducing the memory
footprint of large simulations and providing a high-performance pipeline
for summarizing huge simulation outputs. The arrow-based simulation
output objects in R claim ownership of their files on disk. Those files
are automatically removed when the owning object goes out of scope and
becomes subject to the R garbage collector. While “anonymous”,
parquet-formatted files hold the data in
[`tempdir()`](https://rdrr.io/r/base/tempfile.html) as you are working
in R, functions are provided to move this data to more permanent
locations for later use.

## Installation

You can install the development version of `mrgsim.ds` from
[GitHub](https://github.com/kylebaron/mrgsim.ds) with:

``` r
# install.packages("devtools")
devtools::install_github("kylebaron/mrgsim.ds")
```

## Example

We will illustrate `mrgsim.ds` by doing a simulation.

``` r
library(mrgsim.ds)
library(dplyr)

mod <- modlib_ds("popex", end = 240, outvars = "IPRED,CL")

data <- expand.ev(amt = 100, ii = 24, total = 6, ID = 1:3000)
```

`mrgsim.ds` provides a new
[`mrgsim()`](https://mrgsolve.org/docs/reference/mrgsim.html) variant -
[`mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim_ds.md).
The name implies we are tapping into Apache Arrow
[Dataset](https://arrow.apache.org/docs/r/reference/Dataset.html)
functionality. The simulation below carries `1,446,000` rows.

``` r
out <- mrgsim_ds(mod, data)

out
. Model: popex
. Dim  : 1.4M x 4
. Files: 1 [11.9 Mb]
. Owner: yes
.     ID time       CL    IPRED
. 1:   1  0.0 1.517157 0.000000
. 2:   1  0.0 1.517157 0.000000
. 3:   1  0.5 1.517157 1.382899
. 4:   1  1.0 1.517157 2.275818
. 5:   1  1.5 1.517157 2.837842
. 6:   1  2.0 1.517157 3.176833
. 7:   1  2.5 1.517157 3.365914
. 8:   1  3.0 1.517157 3.454639
```

## Very lightweight simulation output object

The output object doesn’t actually carry these 1.4M rows of simulated
data. Rather it stores a pointer to the data in parquet files on your
disk.

``` r
basename(out$files)
. [1] "mrgsims-ds-cc557150e363.parquet"
```

This means there is almost nothing inside the object itself

``` r
lobstr:::obj_size(out)
. 292.51 kB

dim(out)
. [1] 1446000       4
```

What if we did the same simulation with regular
[`mrgsim()`](https://mrgsolve.org/docs/reference/mrgsim.html)?

``` r
x <- mrgsim(mod, data)

lobstr::obj_size(x)
. 46.30 MB

dim(x)
. [1] 1446000       4
```

The `mrgsim.ds` object is very light weight despite tracking the same
data.

## Handles like regular mrgsim output

But, we can do a lot of the typical things we would with any
[`mrgsim()`](https://mrgsolve.org/docs/reference/mrgsim.html) output
object.

``` r
plot(out, nid = 12)
```

![](reference/figures/README-plot_head_tail_dim-1.png)

``` r
head(out)
. # A tibble: 6 × 4
.      ID  time    CL IPRED
.   <dbl> <dbl> <dbl> <dbl>
. 1     1   0    1.52  0   
. 2     1   0    1.52  0   
. 3     1   0.5  1.52  1.38
. 4     1   1    1.52  2.28
. 5     1   1.5  1.52  2.84
. 6     1   2    1.52  3.18

tail(out)
. # A tibble: 6 × 4
.      ID  time    CL   IPRED
.   <dbl> <dbl> <dbl>   <dbl>
. 1  3000  238.  1.51 0.00566
. 2  3000  238   1.51 0.00550
. 3  3000  238.  1.51 0.00534
. 4  3000  239   1.51 0.00519
. 5  3000  240.  1.51 0.00504
. 6  3000  240   1.51 0.00490

dim(out)
. [1] 1446000       4
```

This includes coercing to different types of objects. We can get the
usual R data frames

``` r
as_tibble(out)
. # A tibble: 1,446,000 × 4
.       ID  time    CL IPRED
.    <dbl> <dbl> <dbl> <dbl>
.  1     1   0    1.52  0   
.  2     1   0    1.52  0   
.  3     1   0.5  1.52  1.38
.  4     1   1    1.52  2.28
.  5     1   1.5  1.52  2.84
.  6     1   2    1.52  3.18
.  7     1   2.5  1.52  3.37
.  8     1   3    1.52  3.45
.  9     1   3.5  1.52  3.48
. 10     1   4    1.52  3.45
. # ℹ 1,445,990 more rows
```

Or stay in the arrow ecosystem

``` r
as_arrow_ds(out)
. FileSystemDataset with 1 Parquet file
. 4 columns
. ID: double
. time: double
. CL: double
. IPRED: double
. 
. See $metadata for additional Schema metadata
```

Or try your hand at duckdb

``` r
as_duckdb_ds(out)
. # Source:   table<arrow_001> [?? x 4]
. # Database: DuckDB 1.4.3 [kyleb@Darwin 24.6.0:R 4.5.2/:memory:]
.       ID  time    CL IPRED
.    <dbl> <dbl> <dbl> <dbl>
.  1     1   0    1.52  0   
.  2     1   0    1.52  0   
.  3     1   0.5  1.52  1.38
.  4     1   1    1.52  2.28
.  5     1   1.5  1.52  2.84
.  6     1   2    1.52  3.18
.  7     1   2.5  1.52  3.37
.  8     1   3    1.52  3.45
.  9     1   3.5  1.52  3.48
. 10     1   4    1.52  3.45
. # ℹ more rows
```

## Tidyverse-friendly

We’ve integrated into the `dplyr` ecosystem as well, allowing you to
[`filter()`](https://dplyr.tidyverse.org/reference/filter.html),
[`group_by()`](https://dplyr.tidyverse.org/reference/group_by.html),
[`mutate()`](https://dplyr.tidyverse.org/reference/mutate.html), or
[`select()`](https://dplyr.tidyverse.org/reference/select.html) your way
directly into a pipeline to summarize your simulations using the power
of Apache Arrow.

``` r
dd <- 
  out %>% 
  group_by(time) %>% 
  summarise(Mean = mean(IPRED, na.rm = TRUE), n = n()) %>% 
  arrange(time)

dd
. FileSystemDataset (query)
. time: double
. Mean: double
. n: int64
. 
. * Sorted by time [asc]
. See $.data for the source Arrow object
```

``` r
collect(dd)
. # A tibble: 481 × 3
.     time  Mean     n
.    <dbl> <dbl> <int>
.  1   0    0     6000
.  2   0.5  1.09  3000
.  3   1    1.78  3000
.  4   1.5  2.25  3000
.  5   2    2.56  3000
.  6   2.5  2.78  3000
.  7   3    2.93  3000
.  8   3.5  3.03  3000
.  9   4    3.09  3000
. 10   4.5  3.13  3000
. # ℹ 471 more rows
```

## Good for large simulations

This workflow is particularly useful when running replicate simulations
in parallel, with large outputs

``` r
library(future.apply, quietly = TRUE)

plan(multisession, workers = 5L)

out2 <- future_lapply(1:10, \(x) { mrgsim_ds(mod, data) }, future.seed = TRUE)

out2 <- reduce_ds(out2)

out2
. Model: popex
. Dim  : 14.5M x 4
. Files: 10 [119.1 Mb]
. Owner: yes
.     ID time       CL     IPRED
. 1:   1  0.0 1.065507 0.0000000
. 2:   1  0.0 1.065507 0.0000000
. 3:   1  0.5 1.065507 0.3164302
. 4:   1  1.0 1.065507 0.5988690
. 5:   1  1.5 1.065507 0.8504344
. 6:   1  2.0 1.065507 1.0739666
. 7:   1  2.5 1.065507 1.2720528
. 8:   1  3.0 1.065507 1.4470496
```

## Files on disk are automagically managed

All `arrow` files are stored in the
[`tempdir()`](https://rdrr.io/r/base/tempfile.html) in parquet format

``` r
list_temp()
. 11 files [131.1 Mb]
. - mrgsims-ds-cc557150e363.parquet
. - mrgsims-ds-cc931cae0455.parquet
.    ...
. - mrgsims-ds-cc9738cfb0c3.parquet
. - mrgsims-ds-cc974b5def58.parquet
```

This directory is eventually removed when the R session ends. Tools are
provided to manage the space.

``` r
retain_temp(out2)
. Discarding 1 files.

list_temp()
. 10 files [119.1 Mb]
. - mrgsims-ds-cc931cae0455.parquet
. - mrgsims-ds-cc93649e7728.parquet
.    ...
. - mrgsims-ds-cc9738cfb0c3.parquet
. - mrgsims-ds-cc974b5def58.parquet
```

We also put a finalizer on each object so that, when it goes out of
scope, the files are automatically cleaned up.

``` r
purge_temp()
. Discarding 10 files.

plan(multisession, workers = 5L)

out1 <- mrgsim_ds(mod, data)
rename_ds(out1, "out1")

out2 <- future_lapply(1:10, \(x) { mrgsim_ds(mod, data) }, future.seed = TRUE)

out2 <- reduce_ds(out2)
rename_ds(out2, "out2")

out3 <- mrgsim_ds(mod, data) 
rename_ds(out3, "out3")
```

``` r
list_temp()
. 12 files [143 Mb]
. - mrgsims-ds-out1-0001.parquet
. - mrgsims-ds-out2-0001.parquet
.    ...
. - mrgsims-ds-out2-0010.parquet
. - mrgsims-ds-out3-0001.parquet

rm(out2)
```

As soon as the garbage collector is called, the leftover files are
cleaned up.

``` r
gc()
.            used  (Mb) gc trigger  (Mb) limit (Mb) max used  (Mb)
. Ncells  1952421 104.3    3644257 194.7         NA  3169014 169.3
. Vcells 15247138 116.4   29097381 222.0      16384 26998816 206.0

list_temp()
. 2 files [23.8 Mb]
. - mrgsims-ds-out1-0001.parquet
. - mrgsims-ds-out3-0001.parquet
```

### Ownership

This setup is only possible if one object owns the files on disk and
`mrgsim.ds` tracks this.

``` r
ownership()
. > Objects: 4 | Files: 13 | Size: 23.8 Mb
```

If I make a copy of a simulation object, the old object no longer owns
the files.

``` r
out4 <- copy_ds(out1, own = TRUE)

check_ownership(out1)
. [1] FALSE

check_ownership(out4)
. [1] TRUE
```

I can always take ownership back.

``` r
take_ownership(out1)

check_ownership(out1)
. [1] TRUE

check_ownership(out4)
. [1] FALSE
```

## If this is so great, why not make it the default for mrgsolve?

There is a cost to all of this. For small to mid-size simulations, you
might see a small slowdown with
[`mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim_ds.md);
it definitely won’t be faster than
[`mrgsim()`](https://mrgsolve.org/docs/reference/mrgsim.html) … even
with the super-quick arrow ecosystem. This workflow is really for large
simulation volumes where you are happy to pay the cost of writing
outputs to file and then streaming them back in to summarize.

# Package index

## Read or load models

Functions to read models configured for use with
[`mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim_ds.md).

- [`mread_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mread_ds.md)
  [`mcode_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mread_ds.md)
  [`modlib_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mread_ds.md)
  [`house_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mread_ds.md)
  [`mread_cache_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mread_ds.md)
  : Read a model specification file for 'Apache' 'Arrow'-backed
  simulation outputs

## Generate Apache Arrow Dataset-backed simulation outputs

Simulate and write output to disk.

- [`mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim_ds.md)
  : Simulate from a model object, returning an arrow-backed output
  object
- [`as_mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/as_mrgsim_ds.md)
  : Coerce an mrgsims object to 'Arrow'-backed mrgsimsds object

## S3 Methods

Work with
[`mrgsim_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim_ds.md)
output.

- [`dim(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsimsds-methods.md)
  [`head(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsimsds-methods.md)
  [`tail(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsimsds-methods.md)
  [`names(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsimsds-methods.md)
  [`plot(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsimsds-methods.md)
  : Interact with mrgsimsds objects

## Move or rename outputs

- [`move_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/move_ds.md)
  [`rename_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/move_ds.md)
  [`write_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/move_ds.md)
  : Move, rename, or write out data set files

## Manage or query ownership

This applies to parquet files holding simulation outputs.

- [`ownership()`](https://kylebaron.github.io/mrgsim.ds/reference/ownership.md)
  [`list_ownership()`](https://kylebaron.github.io/mrgsim.ds/reference/ownership.md)
  [`check_ownership()`](https://kylebaron.github.io/mrgsim.ds/reference/ownership.md)
  [`disown()`](https://kylebaron.github.io/mrgsim.ds/reference/ownership.md)
  [`take_ownership()`](https://kylebaron.github.io/mrgsim.ds/reference/ownership.md)
  : Ownership of simulation files
- [`copy_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/copy_ds.md)
  : Copy an mrgsimsds object

## Work with lists of mrgsimsds objects

Commonly needed after batch simulation in parallel

- [`reduce_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/reduce_ds.md)
  : Reduce a list of mrgsimsds objects into a single object
- [`refresh_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/refresh_ds.md)
  : Refresh 'Arrow' dataset pointers.
- [`prune_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/prune_ds.md)
  : Prune a list of mrgsimsds objects

## Manage simulation outputs in `tempdir()`

- [`list_temp()`](https://kylebaron.github.io/mrgsim.ds/reference/list_temp.md)
  [`retain_temp()`](https://kylebaron.github.io/mrgsim.ds/reference/list_temp.md)
  [`purge_temp()`](https://kylebaron.github.io/mrgsim.ds/reference/list_temp.md)
  : Manage simulated outputs in tempdir()

## Utility functions

- [`file_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/file_ds.md)
  : Create an output file name
- [`save_process_info()`](https://kylebaron.github.io/mrgsim.ds/reference/save_process_info.md)
  : Save information about the R process that loaded a model
- [`is_mrgsimsds()`](https://kylebaron.github.io/mrgsim.ds/reference/is_mrgsimsds.md)
  : Check if object inherits mrgsimsds

## Coerce output to an R object

- [`as_tibble(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/as_tibble.mrgsimsds.md)
  [`collect(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/as_tibble.mrgsimsds.md)
  [`as.data.frame(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/as_tibble.mrgsimsds.md)
  : Coerce an mrgsimsds object to a tbl
- [`as_arrow_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/as_arrow_ds.md)
  : Coerce an mrgsimsds object to an arrow data set
- [`as_arrow_table(`*`<mrgsimsds>`*`)`](https://kylebaron.github.io/mrgsim.ds/reference/as_arrow_table.mrgsimsds.md)
  : Coerce an mrgsimsds object to an arrow table
- [`as_duckdb_ds()`](https://kylebaron.github.io/mrgsim.ds/reference/as_duckdb_ds.md)
  : Coerce an mrgsimsds object to a DuckDB table

## Landing page

- [`mrgsim.ds`](https://kylebaron.github.io/mrgsim.ds/reference/mrgsim.ds.md)
  : mrgsim.ds: 'Apache' 'Arrow' Dataset-Backed Simulation Outputs for
  'mrgsolve'

# Articles

### All vignettes

- [Get
  Started](https://kylebaron.github.io/mrgsim.ds/articles/mrgsim.ds.md):
